name: Build images
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  TAG_NAME: 4.0.1-alpine

jobs:
  build:
    runs-on: ${{ matrix.runner }}
    if: github.ref == 'refs/heads/main'
    timeout-minutes: 30
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux/amd64
            runner: ubuntu-24.04
          - platform: linux/arm64
            runner: ubuntu-24.04-arm

    steps:
      - uses: actions/checkout@v6

      - name: Set platform pair
        run: echo "PLATFORM_PAIR=${platform//\//-}" >> $GITHUB_ENV
        env:
          platform: ${{ matrix.platform }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to ghcr.io
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker meta for BUILDER
        id: meta-builder
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/rails-base-builder

      - name: Build and push BUILDER image by digest
        id: build-builder
        uses: docker/build-push-action@v6
        with:
          context: builder
          platforms: ${{ matrix.platform }}
          provenance: false
          labels: ${{ steps.meta-builder.outputs.labels }}
          outputs: type=image,name=ghcr.io/${{ github.repository_owner }}/rails-base-builder,push-by-digest=true,name-canonical=true,push=true
          cache-from: type=gha,scope=builder-${{ env.PLATFORM_PAIR }}
          cache-to: type=gha,mode=max,scope=builder-${{ env.PLATFORM_PAIR }}

      - name: Export BUILDER digest
        run: |
          mkdir -p /tmp/digests/builder
          digest="${{ steps.build-builder.outputs.digest }}"
          touch "/tmp/digests/builder/${digest#sha256:}"

      - name: Docker meta for FINAL
        id: meta-final
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/rails-base-final

      - name: Build and push FINAL image by digest
        id: build-final
        uses: docker/build-push-action@v6
        with:
          context: final
          platforms: ${{ matrix.platform }}
          provenance: false
          labels: ${{ steps.meta-final.outputs.labels }}
          outputs: type=image,name=ghcr.io/${{ github.repository_owner }}/rails-base-final,push-by-digest=true,name-canonical=true,push=true
          cache-from: type=gha,scope=final-${{ env.PLATFORM_PAIR }}
          cache-to: type=gha,mode=max,scope=final-${{ env.PLATFORM_PAIR }}

      - name: Export FINAL digest
        run: |
          mkdir -p /tmp/digests/final
          digest="${{ steps.build-final.outputs.digest }}"
          touch "/tmp/digests/final/${digest#sha256:}"

      - name: Upload digests
        uses: actions/upload-artifact@v6
        with:
          name: digests-${{ env.PLATFORM_PAIR }}
          path: /tmp/digests
          if-no-files-found: error
          retention-days: 1

  push:
    runs-on: ubuntu-24.04
    needs: build
    if: github.ref == 'refs/heads/main'
    timeout-minutes: 10
    permissions:
      packages: write

    steps:
      - name: Download digests
        uses: actions/download-artifact@v7
        with:
          path: /tmp/digests
          pattern: digests-*
          merge-multiple: true

      - name: Login to ghcr.io
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push BUILDER manifest
        working-directory: /tmp/digests/builder
        run: |
          docker buildx imagetools create \
            -t ghcr.io/${{ github.repository_owner }}/rails-base-builder:${{ env.TAG_NAME }} \
            -t ghcr.io/${{ github.repository_owner }}/rails-base-builder:latest \
            $(printf 'ghcr.io/${{ github.repository_owner }}/rails-base-builder@sha256:%s ' *)

      - name: Create and push FINAL manifest
        working-directory: /tmp/digests/final
        run: |
          docker buildx imagetools create \
            -t ghcr.io/${{ github.repository_owner }}/rails-base-final:${{ env.TAG_NAME }} \
            -t ghcr.io/${{ github.repository_owner }}/rails-base-final:latest \
            $(printf 'ghcr.io/${{ github.repository_owner }}/rails-base-final@sha256:%s ' *)

      - name: Inspect BUILDER image
        run: docker buildx imagetools inspect ghcr.io/${{ github.repository_owner }}/rails-base-builder:${{ env.TAG_NAME }}

      - name: Inspect FINAL image
        run: docker buildx imagetools inspect ghcr.io/${{ github.repository_owner }}/rails-base-final:${{ env.TAG_NAME }}
